---
phase: 03-prompt-generation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/hooks/useDailyPrompt.ts
  - app/(auth)/index.tsx
autonomous: false

must_haves:
  truths:
    - "User sees today's personalized prompt on home screen in a large, obvious card"
    - "Opening app multiple times on same day shows the same daily prompt"
    - "User can tap Generate Now to get a new extra prompt that replaces display"
    - "Home screen has I made something button (placeholder for Phase 4)"
    - "Prompt card shows medium, optional color rule, and optional twist details"
    - "Loading state shown while prompt fetches, error state shown on failure"
  artifacts:
    - path: "lib/hooks/useDailyPrompt.ts"
      provides: "React hook for fetching and managing daily prompt state"
      exports: ["useDailyPrompt"]
    - path: "app/(auth)/index.tsx"
      provides: "Home screen with prompt card, Generate Now, and I made something buttons"
      min_lines: 60
  key_links:
    - from: "lib/hooks/useDailyPrompt.ts"
      to: "lib/services/prompts.ts"
      via: "getTodayPrompt and createManualPrompt imports"
      pattern: "import.*getTodayPrompt.*createManualPrompt.*from.*services/prompts"
    - from: "lib/hooks/useDailyPrompt.ts"
      to: "components/auth/SessionProvider.tsx"
      via: "useSession hook for user ID"
      pattern: "import.*useSession.*from.*SessionProvider"
    - from: "app/(auth)/index.tsx"
      to: "lib/hooks/useDailyPrompt.ts"
      via: "useDailyPrompt hook consumption"
      pattern: "import.*useDailyPrompt.*from.*hooks/useDailyPrompt"
    - from: "app/(auth)/index.tsx"
      to: "User interaction"
      via: "Generate Now button calls generateManualPrompt"
      pattern: "onPress.*generateManualPrompt|handleGenerateNow"
---

<objective>
Build the useDailyPrompt hook and replace the placeholder home screen with the real prompt display. The home screen prominently shows today's personalized prompt in a large card with "Generate Now" and "I made something" action buttons.

Purpose: This is what users actually see and interact with. The prompt service from Plan 01 does the heavy lifting; this plan wires it into a clean, artistic UI that embodies the app's core value -- one clear prompt that sparks creation.

Output: Working home screen showing today's prompt with action buttons, backed by a React hook that handles fetching, caching, and on-demand generation.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-prompt-generation/03-RESEARCH.md
@.planning/phases/03-prompt-generation/03-01-SUMMARY.md

# Existing files this plan integrates with
@lib/services/prompts.ts
@lib/schemas/prompts.ts
@components/auth/SessionProvider.tsx
@app/(auth)/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDailyPrompt hook with AsyncStorage caching</name>
  <files>lib/hooks/useDailyPrompt.ts</files>
  <action>
Create `lib/hooks/useDailyPrompt.ts` -- a custom React hook that manages daily prompt state.

**Hook signature:**
```typescript
export function useDailyPrompt(): {
  prompt: Prompt | null;
  loading: boolean;
  error: string | null;
  generating: boolean;
  generateManualPrompt: () => Promise<void>;
}
```

**Implementation:**

1. **State:** `prompt` (Prompt | null), `loading` (boolean, default true), `error` (string | null), `generating` (boolean, default false)

2. **Session:** Get `session` from `useSession()` hook. Extract `userId = session?.user?.id`.

3. **useEffect on mount** (dependency: userId):
   - If no userId AND `__DEV__` is true: set a mock prompt with hardcoded values (medium: "watercolor", subject: "botanicals", prompt_text: "Create a watercolor piece featuring botanicals. Focus on texture over detail", source: "daily", date_key: today), set loading false, return
   - If no userId: set loading false, return (no-op for unauthenticated state)
   - Try:
     - Build cache key: `@artspark:daily-prompt:${new Date().toISOString().split('T')[0]}`
     - Check AsyncStorage for cached prompt
     - If cached: parse JSON, setPrompt, setLoading(false), return early
     - If not cached: call `getTodayPrompt(userId)`
     - setPrompt with result
     - Cache result in AsyncStorage with the date-based key
     - setLoading(false)
   - Catch: setError with message, setLoading(false)

4. **generateManualPrompt function:**
   - If no userId, return early
   - setGenerating(true), clear error
   - Try:
     - Call `createManualPrompt(userId)`
     - setPrompt with result (replaces displayed prompt)
     - Do NOT cache manual prompts (daily cache should still show daily prompt on next app open)
   - Catch: setError with message
   - Finally: setGenerating(false)

**Imports:**
- `{ useState, useEffect }` from 'react'
- `{ getTodayPrompt, createManualPrompt }` from `@/lib/services/prompts`
- `{ Prompt }` from `@/lib/schemas/prompts`
- `{ useSession }` from `@/components/auth/SessionProvider`
- `AsyncStorage` from `@react-native-async-storage/async-storage`

**IMPORTANT:** The `generating` state is separate from `loading`. `loading` is the initial fetch on mount. `generating` is the "Generate Now" button spinner. They should not interfere with each other.
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify:
- File exports `useDailyPrompt` function
- Hook returns { prompt, loading, error, generating, generateManualPrompt }
- Imports getTodayPrompt and createManualPrompt from services
- Uses AsyncStorage for cache with date-based key
- Has __DEV__ mock prompt fallback
  </verify>
  <done>
useDailyPrompt hook exists, compiles cleanly, returns prompt/loading/error/generating/generateManualPrompt. Fetches on mount with AsyncStorage cache, generates on-demand via manual function, has dev mode fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace placeholder home screen with prompt card and action buttons</name>
  <files>app/(auth)/index.tsx</files>
  <action>
**REPLACE** the existing placeholder `app/(auth)/index.tsx` (currently shows "Welcome!" text and Settings button) with the full home screen.

**Layout structure (ScrollView-based):**

```
ScrollView (flex-1, bg-[#FFF8F0])
  View (px-6, pt-12, pb-8)
    -- Header area --
    Text "ArtSpark" (small, sage green, centered or left-aligned)
    Text "Today's Prompt" or "Extra Prompt" label (small, gray-500)

    -- Prompt Card (the main event) --
    View (bg-white, rounded-2xl, p-6, shadow-sm, mb-6)
      Text: prompt_text (text-2xl, font-semibold, text-gray-900, leading-relaxed)
      -- Details section (below a thin border-t) --
      View (mt-4, pt-4, border-t, border-gray-100)
        Text "Medium" label (text-xs, text-gray-400)
        Text: medium label (text-sm, text-gray-700)
        If color_rule:
          Text "Colors" label
          Text: color_rule label
        If twist:
          Text "Twist" label
          Text: twist text (italic, text-[#7C9A72])

    -- Action Buttons --
    TouchableOpacity "I made something" (bg-[#7C9A72], rounded-xl, py-4, mb-3)
      Text (text-white, text-center, text-lg, font-semibold)
      onPress: show Alert.alert("Coming Soon", "Response capture is coming in the next update!") -- Phase 4 placeholder
    TouchableOpacity "Generate Now" (bg-white, border-2, border-[#7C9A72], rounded-xl, py-4)
      Text (text-[#7C9A72], text-center, text-lg, font-semibold)
      onPress: call generateManualPrompt from hook
      disabled: generating state
      Show "Generating..." text when generating is true

    -- Settings link (subtle, bottom of screen) --
    TouchableOpacity (mt-8) linking to /(auth)/settings
      Text "Settings" (text-gray-400, text-center, text-sm, underline)
```

**States to handle:**
1. **Loading:** Show ActivityIndicator (large, color="#7C9A72") centered on cream background
2. **Error:** Show error message in red-600 centered on cream background, with a "Try Again" button that reloads
3. **Success:** Show the full prompt card layout above

**Styling notes (LOCKED decisions):**
- Cream background: `bg-[#FFF8F0]` (not bg-cream -- no custom tailwind color defined)
- Sage green: `#7C9A72` used as `bg-[#7C9A72]` for primary buttons, `text-[#7C9A72]` for secondary
- Big, obvious buttons with `py-4` and `text-lg` (UX-02)
- Clean card layout with shadow-sm, rounded-2xl (UX-01, StoryGraph-inspired)
- Details section is visible below prompt text (not collapsible for v1 -- keep it simple)
- Accessible font sizes: prompt text at text-2xl, buttons at text-lg (UX-04)

**Medium/color label lookup for display:**
Import `MEDIUM_OPTIONS`, `COLOR_PALETTE_OPTIONS` from `@/lib/constants/preferences` and create a helper function to look up display labels from IDs:
```typescript
function getLabel(options: { id: string; label: string }[], id: string): string {
  return options.find(o => o.id === id)?.label || id;
}
```
Use this to display medium and color_rule labels in the card details section.

**Imports needed:**
- `{ View, Text, TouchableOpacity, ActivityIndicator, ScrollView, Alert }` from 'react-native'
- `{ router }` from 'expo-router'
- `{ useDailyPrompt }` from `@/lib/hooks/useDailyPrompt`
- `{ MEDIUM_OPTIONS, COLOR_PALETTE_OPTIONS }` from `@/lib/constants/preferences`
- SafeAreaView from 'react-native-safe-area-context' if needed for top padding (check if the (auth) layout already provides SafeAreaView -- if so, just use View)

**Do NOT import useSession** -- the hook handles session access internally.
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify:
- File imports useDailyPrompt hook
- File renders prompt_text in a large card
- File has "I made something" button with Alert placeholder
- File has "Generate Now" button calling generateManualPrompt
- File has loading and error states
- File uses cream (#FFF8F0) and sage green (#7C9A72) colors
- File has Settings link at bottom
  </verify>
  <done>
Home screen displays today's prompt in a large white card on cream background. "I made something" button shows coming soon alert. "Generate Now" button triggers manual prompt generation with loading state. Medium and color details shown below prompt text. Loading spinner and error state handled. Settings link preserved at bottom. All artistic styling follows locked design direction.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify prompt generation and home screen</name>
  <files>app/(auth)/index.tsx, lib/hooks/useDailyPrompt.ts</files>
  <action>
CHECKPOINT: Human verification of the complete prompt generation flow and home screen UI.

What was built: Complete prompt generation flow -- service layer generates personalized prompts from user preferences, useDailyPrompt hook fetches and caches them, home screen displays prompt in a large artistic card with Generate Now and I made something buttons.

How to verify:
1. Start the app: `npx expo start` from project root
2. Open in simulator/device
3. Navigate through auth and onboarding (or use dev bypass)
4. Home screen should show: cream background, large white card with prompt text, prompt details (medium, optional colors, optional twist in sage green italic), "I made something" button in sage green, "Generate Now" button in white with sage green border
5. Tap "Generate Now" -- should show "Generating..." briefly, then display a NEW prompt
6. Close and reopen app -- should show the SAME daily prompt (date_key deduplication)
7. Check overall feel: artistic, clean, minimal, big obvious buttons, prompt text as focal point

NOTE: If Supabase prompts table not yet created, dev mock data will display instead.
  </action>
  <verify>User confirms the home screen looks correct and prompt generation works as expected.</verify>
  <done>User types "approved" confirming the prompt display, Generate Now, and I made something buttons all work correctly with artistic styling.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors from Phase 3 files
2. Two new files exist: lib/hooks/useDailyPrompt.ts, app/(auth)/index.tsx (replaced)
3. Home screen shows prompt card (not placeholder "Welcome!" text)
4. "Generate Now" produces a new prompt
5. "I made something" shows placeholder alert
6. Prompt text combines medium + subject + optional color + optional twist
7. Same daily prompt shown on multiple app opens (same day)
8. Artistic styling: cream background, sage green accents, big buttons, clean card
</verification>

<success_criteria>
- Home screen prominently displays today's prompt (HOME-01)
- "Generate Now" button generates extra prompt (HOME-02, PGEN-06)
- "I made something" button exists as placeholder (HOME-03)
- Clean card layout with big buttons (UX-01, UX-02)
- Details section shows medium/color/twist (UX-03 inspired)
- Accessible font sizes and good contrast (UX-04)
- Same daily prompt on multiple opens (PGEN-05)
- Hook handles loading, error, and generating states cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-prompt-generation/03-02-SUMMARY.md`
</output>
