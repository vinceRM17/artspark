---
phase: 06-notifications-settings
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/(auth)/settings.tsx
  - app/(auth)/_layout.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle daily notifications on/off from Settings and the notification schedule responds accordingly"
    - "User can change notification time in Settings and the daily notification immediately reschedules to the new time"
    - "User can edit art mediums, color palettes, subjects, and exclusions from Settings using the same chip selection UI as onboarding"
    - "User sees a disabled 'Pro' toggle with 'Coming Soon' label in Settings"
    - "User can reset prompt history via a danger zone button with confirmation dialog"
    - "User sees their account email and can log out from Settings"
  artifacts:
    - path: "app/(auth)/settings.tsx"
      provides: "Complete settings screen with all sections"
      min_lines: 150
    - path: "app/(auth)/_layout.tsx"
      provides: "Updated navigation with settings screen title"
  key_links:
    - from: "app/(auth)/settings.tsx"
      to: "lib/services/preferences.ts"
      via: "getPreferences and savePreferences calls"
      pattern: "getPreferences|savePreferences"
    - from: "app/(auth)/settings.tsx"
      to: "lib/notifications.ts"
      via: "rescheduleDailyPrompt, cancelAllNotifications, getNotificationPermissionStatus"
      pattern: "rescheduleDailyPrompt|cancelAllNotifications|getNotificationPermissionStatus"
    - from: "app/(auth)/settings.tsx"
      to: "lib/services/prompts.ts"
      via: "resetPromptHistory for danger zone"
      pattern: "resetPromptHistory"
    - from: "app/(auth)/settings.tsx"
      to: "lib/hooks/usePromptHistory.ts"
      via: "invalidateHistoryCache after reset"
      pattern: "invalidateHistoryCache"
    - from: "app/(auth)/settings.tsx"
      to: "components/settings/*"
      via: "SettingSection, SettingRow, NotificationTimePicker, DangerZone imports"
      pattern: "SettingSection|SettingRow|NotificationTimePicker|DangerZone"
    - from: "app/(auth)/settings.tsx"
      to: "components/onboarding/ChipGrid.tsx"
      via: "Reuse for preference editing"
      pattern: "ChipGrid"
---

<objective>
Build the complete settings screen by composing Plan 01's components and service functions into a full-featured settings page with notifications, preference editing, Pro placeholder, account info, and danger zone.

Purpose: This is the final user-facing deliverable of Phase 6 and the entire app. Users can manage all aspects of their ArtSpark experience from one screen.

Output: Fully functional settings.tsx with all 8 requirements (NOTF-01 through NOTF-04, SETT-01 through SETT-04) satisfied, plus human verification of the complete experience.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notifications-settings/06-RESEARCH.md
@.planning/phases/06-notifications-settings/06-01-SUMMARY.md

# Key source files
@app/(auth)/settings.tsx
@app/(auth)/_layout.tsx
@lib/notifications.ts
@lib/services/preferences.ts
@lib/services/prompts.ts
@lib/hooks/usePromptHistory.ts
@lib/constants/preferences.ts
@components/settings/SettingSection.tsx
@components/settings/SettingRow.tsx
@components/settings/NotificationTimePicker.tsx
@components/settings/DangerZone.tsx
@components/onboarding/ChipGrid.tsx
@components/auth/SessionProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build complete settings screen with all sections</name>
  <files>
    app/(auth)/settings.tsx
  </files>
  <action>
Completely rewrite `app/(auth)/settings.tsx` to be the full settings screen. This is a large component but it's a single screen composing pre-built components. Use a ScrollView (NOT SectionList — research recommends ScrollView for this amount of settings).

**Imports needed:**
- React: `useState, useEffect, useCallback`
- React Native: `View, Text, ScrollView, Switch, Alert, ActivityIndicator, Linking, TouchableOpacity`
- Navigation: `useSession` from `@/components/auth/SessionProvider`, `router` from `expo-router`
- Services: `getPreferences, savePreferences, UserPreferences` from `@/lib/services/preferences`
- Services: `resetPromptHistory` from `@/lib/services/prompts`
- Notifications: `rescheduleDailyPrompt, cancelAllNotifications, getNotificationPermissionStatus, getAndStorePushToken` from `@/lib/notifications`
- Cache: `invalidateHistoryCache` from `@/lib/hooks/usePromptHistory`
- Constants: `MEDIUM_OPTIONS, COLOR_PALETTE_OPTIONS, SUBJECT_OPTIONS` from `@/lib/constants/preferences`
- Components: `SettingSection` from `@/components/settings/SettingSection`
- Components: `SettingRow` from `@/components/settings/SettingRow`
- Components: `NotificationTimePicker` from `@/components/settings/NotificationTimePicker`
- Components: `DangerZone` from `@/components/settings/DangerZone`
- Components: `ChipGrid` from `@/components/onboarding/ChipGrid`

**State:**
- `loading: boolean` — initial data load
- `preferences: UserPreferences | null` — current user preferences from Supabase
- `notificationEnabled: boolean` — local toggle state
- `notificationHour: number` — local hour state (default 9)
- `notificationMinute: number` — local minute state (default 0)
- `notificationPermission: string` — permission status string
- `mediums: string[]` — local selected mediums
- `colorPalettes: string[]` — local selected color palettes
- `subjects: string[]` — local selected subjects
- `exclusions: string[]` — local selected exclusions
- `savingPreferences: boolean` — saving indicator
- `resettingHistory: boolean` — resetting indicator
- `editingSection: string | null` — which preference section is expanded for editing ('mediums' | 'colors' | 'subjects' | 'exclusions' | null)

**useEffect on mount:**
1. Call `getPreferences(userId)` (use session.user.id, with __DEV__ fallback to 'dev-user')
2. If preferences exist, populate all local state from preferences:
   - `notificationEnabled` from `preferences.notification_enabled`
   - Parse `preferences.notification_time` (HH:MM:SS string) into hour and minute integers
   - `mediums` from `preferences.art_mediums`
   - `colorPalettes` from `preferences.color_palettes`
   - `subjects` from `preferences.subjects`
   - `exclusions` from `preferences.exclusions`
3. Call `getNotificationPermissionStatus()` and store in `notificationPermission`
4. Set `loading = false`

**Handler functions:**

`handleNotificationToggle(value: boolean)`:
- Optimistic: set `notificationEnabled = value`
- If value is true:
  - Check permission status. If denied, show Alert with "Notifications are disabled in your device settings" and button to open Settings via `Linking.openSettings()`. Revert toggle.
  - If permission OK, call `rescheduleDailyPrompt(notificationHour, notificationMinute)` and `savePreferences(userId, { notification_enabled: true })`
  - Also call `getAndStorePushToken(userId)` (fire and forget)
- If value is false:
  - Call `cancelAllNotifications()` and `savePreferences(userId, { notification_enabled: false })`
- On error: revert toggle, show Alert

`handleTimeChange(hour: number, minute: number)`:
- Set local state: `notificationHour = hour`, `notificationMinute = minute`
- Format as HH:MM:SS string (pad with zeros)
- Call `savePreferences(userId, { notification_time: timeString })`
- If `notificationEnabled`, call `rescheduleDailyPrompt(hour, minute)` to reschedule
- On error: show Alert

`handleTogglePreference(type: 'mediums' | 'colors' | 'subjects' | 'exclusions', id: string)`:
- Toggle the id in the corresponding local array (add if not present, remove if present)
- The subjects array must have at least 1 item (don't allow removing last subject)
- The mediums array must have at least 1 item (don't allow removing last medium)
- If user tries to remove last required item, show Alert: "You need at least one [medium/subject] selected"

`handleSavePreferences()`:
- Set `savingPreferences = true`
- Filter exclusions to remove any that are also in subjects (same logic as onboarding step-4)
- Call `savePreferences(userId, { art_mediums: mediums, color_palettes: colorPalettes, subjects: subjects, exclusions: filteredExclusions })`
- Set `editingSection = null` to collapse editor
- Set `savingPreferences = false`
- On error: Alert

`handleResetHistory()`:
- Set `resettingHistory = true`
- Call `resetPromptHistory(userId)` from prompts service
- Call `invalidateHistoryCache()` to clear local cache
- Alert.alert('Success', 'Your prompt history has been reset.')
- Set `resettingHistory = false`
- On error: Alert, set resettingHistory = false

`handleLogout()`:
- Same as existing: Alert confirmation, then `signOut()` and `router.replace('/sign-in')`

**Screen layout (ScrollView with cream bg):**

```
ScrollView className="flex-1 bg-[#FFF8F0]"

  // Section 1: Notifications
  SettingSection title="Notifications"
    SettingRow label="Daily Reminders"
      description={permission status text like "Notifications allowed" or "Notifications disabled in device settings"}
      rightElement={<Switch trackColor sage green, value=notificationEnabled, onValueChange=handleNotificationToggle />}

    SettingRow label="Reminder Time"
      description="When to send your daily art prompt"
      rightElement={<NotificationTimePicker hour minute onChange=handleTimeChange disabled={!notificationEnabled} />}

  // Section 2: Art Preferences (expandable sections)
  SettingSection title="Art Preferences"
    SettingRow label="Mediums"
      description={`${mediums.length} selected`}
      onPress={() => setEditingSection(editingSection === 'mediums' ? null : 'mediums')}
      rightElement={<Text className="text-gray-400">Edit</Text>}

    {editingSection === 'mediums' && (
      <View className="px-4 py-3 bg-gray-50">
        <ChipGrid options={MEDIUM_OPTIONS} selectedIds={mediums} onToggle={(id) => handleTogglePreference('mediums', id)} />
        <TouchableOpacity onPress={handleSavePreferences} className="bg-[#7C9A72] rounded-lg py-2.5 mt-4">
          <Text className="text-white text-center font-semibold">{savingPreferences ? 'Saving...' : 'Save Changes'}</Text>
        </TouchableOpacity>
      </View>
    )}

    // Same pattern for Colors, Subjects, Exclusions
    // Colors: COLOR_PALETTE_OPTIONS, description shows count or "None selected"
    // Subjects: SUBJECT_OPTIONS, description shows count
    // Exclusions: SUBJECT_OPTIONS (same list, user picks what to exclude), description shows count or "None"

  // Section 3: Pro
  SettingSection title="Subscription"
    SettingRow label="ArtSpark Pro"
      description="Coming Soon (~$25/yr)"
      rightElement={<Switch value={false} disabled trackColor={{ false: '#D1D5DB', true: '#7C9A72' }} />}

  // Section 4: Account
  SettingSection title="Account"
    SettingRow label="Email" description={session?.user?.email || 'Not signed in'}
    SettingRow label="Log Out" onPress={handleLogout} rightElement={<Text className="text-red-500">Log Out</Text>}

  // Section 5: Danger Zone
  DangerZone onResetHistory={handleResetHistory} resetting={resettingHistory}

  // Footer
  View className="px-6 py-8"
    Text className="text-xs text-gray-400 text-center"
      "ArtSpark v1.0.0"

  // Bottom padding for scroll
```

**Loading state:** While `loading`, show centered ActivityIndicator on cream bg.

**Dev mode:** When no session (dev mode), use 'dev-user' as userId. Populate sensible defaults if preferences are null.
  </action>
  <verify>
- `grep -c "SettingSection\|SettingRow\|NotificationTimePicker\|DangerZone\|ChipGrid" app/\(auth\)/settings.tsx` returns 5+ (all component imports present)
- `grep -c "rescheduleDailyPrompt\|cancelAllNotifications\|getNotificationPermissionStatus" app/\(auth\)/settings.tsx` returns 3+ (notification service functions used)
- `grep -c "resetPromptHistory" app/\(auth\)/settings.tsx` returns 1+ (danger zone wired)
- `grep -c "invalidateHistoryCache" app/\(auth\)/settings.tsx` returns 1+ (cache invalidation after reset)
- `grep -c "Coming Soon" app/\(auth\)/settings.tsx` returns 1+ (Pro placeholder present)
- `grep -c "handleNotificationToggle\|handleTimeChange\|handleSavePreferences\|handleResetHistory\|handleLogout" app/\(auth\)/settings.tsx` returns 5+ (all handlers present)
- `npx tsc --noEmit` passes
  </verify>
  <done>
Complete settings screen with 5 sections: Notifications (toggle + time picker with reschedule), Art Preferences (expandable chip grids for mediums/colors/subjects/exclusions with save), Subscription (Pro placeholder), Account (email + logout), and Danger Zone (reset history with confirmation). All handlers implement optimistic UI with error rollback.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete settings screen</name>
  <files>app/(auth)/settings.tsx</files>
  <action>
Human verification of the complete settings screen. All Phase 6 requirements should be working:
- NOTF-01: Notification permission status display with link to device settings
- NOTF-02: Daily notification toggle (on/off)
- NOTF-03: Notification time picker that reschedules on change
- NOTF-04: Push token stored on notification enable
- SETT-01: Expandable preference editors for mediums, colors, subjects, exclusions
- SETT-02: Notification enable/disable and time change
- SETT-03: Pro (Coming Soon) disabled toggle
- SETT-04: Reset prompt history with confirmation dialog

Steps to verify:
1. Run `npx expo start` and navigate to Settings screen
2. **Notifications section:** Toggle daily reminders on/off, tap time to change it (verify native picker appears), verify time display updates
3. **Art Preferences section:** Tap "Edit" on Mediums — verify chip grid expands, toggle chips, tap "Save Changes". Try removing all mediums or subjects — verify "at least 1" alert
4. **Subscription section:** Verify "ArtSpark Pro" with "Coming Soon (~$25/yr)" and disabled switch
5. **Account section:** Verify email displayed, tap "Log Out" — verify confirmation dialog
6. **Danger Zone:** Tap "Reset Prompt History" — verify confirmation with destructive red button (cancel, don't actually reset)
7. **General:** Cream background, sage green accents, white cards, smooth scrolling, "ArtSpark v1.0.0" footer
  </action>
  <verify>User confirms all sections render correctly and interactions work as expected</verify>
  <done>User types "approved" to confirm the settings screen works correctly, or describes issues that need fixing</done>
</task>

</tasks>

<verification>
- Settings screen loads user preferences on mount
- Notification toggle schedules/cancels daily notifications
- Changing notification time immediately reschedules the notification
- All 4 preference categories (mediums, colors, subjects, exclusions) editable with chip grids
- At least 1 medium and 1 subject enforced
- Pro placeholder shows disabled switch with "Coming Soon" label
- Reset history shows confirmation dialog before deleting
- After reset, history cache is invalidated
- Account section shows email and logout
- All styling follows cream/sage/white design system
- No TypeScript errors
</verification>

<success_criteria>
- All 8 requirements (NOTF-01 through NOTF-04, SETT-01 through SETT-04) are implemented
- Settings screen is visually consistent with the rest of the app
- All handlers work correctly (notification toggle, time change, preference save, reset, logout)
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/06-notifications-settings/06-02-SUMMARY.md`
</output>
