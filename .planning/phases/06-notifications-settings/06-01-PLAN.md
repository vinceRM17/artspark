---
phase: 06-notifications-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/notifications.ts
  - lib/services/prompts.ts
  - app.json
  - components/settings/SettingSection.tsx
  - components/settings/SettingRow.tsx
  - components/settings/NotificationTimePicker.tsx
  - components/settings/DangerZone.tsx
autonomous: true

must_haves:
  truths:
    - "Android notification channel is created at module level for reliable notification delivery on Android 8+"
    - "Expo push token can be retrieved and stored in user_preferences for future remote notification capability"
    - "Notification permission status can be checked without re-requesting (for settings UI display)"
    - "Prompt history can be deleted from Supabase with a single service call"
    - "Settings components render section headers, toggle rows, time picker, and danger zone with consistent cream/sage styling"
  artifacts:
    - path: "lib/notifications.ts"
      provides: "Extended notification service with Android channel, push token, permission check, reschedule"
      exports: ["requestNotificationPermission", "scheduleDailyPrompt", "cancelAllNotifications", "setupNotificationChannel", "getAndStorePushToken", "getNotificationPermissionStatus", "rescheduleDailyPrompt"]
    - path: "lib/services/prompts.ts"
      provides: "resetPromptHistory function for danger zone"
      exports: ["resetPromptHistory"]
    - path: "app.json"
      provides: "expo-notifications plugin and Android SCHEDULE_EXACT_ALARM permission"
      contains: "expo-notifications"
    - path: "components/settings/SettingSection.tsx"
      provides: "Grouped settings section with header label"
    - path: "components/settings/SettingRow.tsx"
      provides: "Individual setting row with label, optional description, and right-side control slot"
    - path: "components/settings/NotificationTimePicker.tsx"
      provides: "Platform-specific time picker (iOS spinner component, Android imperative DateTimePickerAndroid.open)"
    - path: "components/settings/DangerZone.tsx"
      provides: "Red-styled danger section with reset history button and confirmation dialog"
  key_links:
    - from: "lib/notifications.ts"
      to: "expo-notifications"
      via: "import * as Notifications"
      pattern: "Notifications\\.setNotificationChannelAsync"
    - from: "lib/notifications.ts"
      to: "lib/services/preferences.ts"
      via: "savePreferences for push token storage"
      pattern: "savePreferences.*expo_push_token"
    - from: "components/settings/NotificationTimePicker.tsx"
      to: "@react-native-community/datetimepicker"
      via: "DateTimePicker component and DateTimePickerAndroid imperative API"
      pattern: "DateTimePickerAndroid\\.open"
    - from: "components/settings/DangerZone.tsx"
      to: "react-native Alert"
      via: "Alert.alert with destructive style button"
      pattern: "style.*destructive"
---

<objective>
Build the service layer extensions and reusable settings UI components needed by the full settings screen.

Purpose: Create all building blocks (notification helpers, prompt history reset, settings UI components) so Plan 02 can assemble the complete settings screen by composing these pieces.

Output: Extended lib/notifications.ts with Android channel + push token + reschedule, resetPromptHistory in prompts service, app.json config updates, and 4 settings components (SettingSection, SettingRow, NotificationTimePicker, DangerZone).
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notifications-settings/06-RESEARCH.md
@.planning/phases/02-onboarding-preferences/02-03-SUMMARY.md

# Key source files to read before implementing
@lib/notifications.ts
@lib/services/prompts.ts
@lib/services/preferences.ts
@app.json
@components/onboarding/PreferenceChip.tsx
@components/onboarding/ChipGrid.tsx
@lib/constants/preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend notification service and add prompt history reset</name>
  <files>
    lib/notifications.ts
    lib/services/prompts.ts
    app.json
  </files>
  <action>
**lib/notifications.ts** - Add these new exports while keeping ALL existing functions (requestNotificationPermission, scheduleDailyPrompt, cancelAllNotifications) and the module-level setNotificationHandler untouched:

1. `setupNotificationChannel()` — Create Android notification channel at module level (call immediately, not in a hook). If `Platform.OS === 'android'`, call `Notifications.setNotificationChannelAsync('default', { name: 'Daily Art Prompts', importance: Notifications.AndroidImportance.HIGH, vibrationPattern: [0, 250, 250, 250], lightColor: '#7C9A72', sound: 'default' })`. On iOS this is a no-op. Call this function at the bottom of the module (self-executing) so channel exists before any notification is scheduled.

2. `getAndStorePushToken(userId: string)` — Try to get Expo push token via `Notifications.getExpoPushTokenAsync({ projectId: Constants.expoConfig?.extra?.eas?.projectId })`. If successful, call `savePreferences(userId, { expo_push_token: token.data })` (import savePreferences from '@/lib/services/preferences'). Return token.data string or null on failure. Wrap in try/catch, log error but don't throw. Note: the user_preferences table may need an `expo_push_token` column added later — for now save it as part of the upsert which will ignore unknown columns gracefully in Supabase, OR add a comment noting this needs a DB migration.

3. `getNotificationPermissionStatus()` — Returns `Promise<{ status: string; canRequest: boolean }>`. Calls `Notifications.getPermissionsAsync()`. Returns `{ status: result.status, canRequest: result.canAskAgain }`. This is for the settings screen to display current permission state without re-requesting.

4. `rescheduleDailyPrompt(hour: number, minute: number)` — Thin wrapper that calls `cancelAllNotifications()` then `scheduleDailyPrompt(hour, minute)`. Returns the notification identifier. This makes the cancel-then-reschedule pattern explicit for settings usage.

Import `Platform` from 'react-native', `Constants` from 'expo-constants', and `savePreferences` from '@/lib/services/preferences'.

**lib/services/prompts.ts** — Add a new export `resetPromptHistory(userId: string)`:
- Delete all rows from `prompts` table where `user_id = userId` using `supabase.from('prompts').delete().eq('user_id', userId)`
- Then delete all rows from `responses` table where `user_id = userId` using `supabase.from('responses').delete().eq('user_id', userId)`
- Prompts first, then responses (order matters if there are FK constraints; if responses have FK to prompts, delete responses first then prompts)
- Actually, check the schema: responses likely reference prompt_id. So delete responses FIRST (child), then prompts (parent).
- Throw on error from either operation.
- Return `{ promptsDeleted: true, responsesDeleted: true }` on success.

**app.json** — Add `"expo-notifications"` to the plugins array (after existing entries). Add `"permissions": ["android.permission.SCHEDULE_EXACT_ALARM"]` inside the `"android"` object. The existing plugins are: `["expo-router", "expo-secure-store", "@react-native-community/datetimepicker"]`. Add expo-notifications after datetimepicker.
  </action>
  <verify>
- `grep -c "setupNotificationChannel\|getAndStorePushToken\|getNotificationPermissionStatus\|rescheduleDailyPrompt" lib/notifications.ts` returns 4+ (all new exports present)
- `grep -c "resetPromptHistory" lib/services/prompts.ts` returns 1+ (new export present)
- `grep -c "expo-notifications" app.json` returns 1+ (plugin added)
- `grep -c "SCHEDULE_EXACT_ALARM" app.json` returns 1+ (permission added)
- `npx tsc --noEmit` passes (no TypeScript errors)
  </verify>
  <done>
lib/notifications.ts exports 7 functions (3 existing + 4 new), Android notification channel is set up at module level, push token storage helper exists, permission status check exists, reschedule wrapper exists. lib/services/prompts.ts exports resetPromptHistory. app.json has expo-notifications plugin and Android SCHEDULE_EXACT_ALARM permission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build settings UI components</name>
  <files>
    components/settings/SettingSection.tsx
    components/settings/SettingRow.tsx
    components/settings/NotificationTimePicker.tsx
    components/settings/DangerZone.tsx
  </files>
  <action>
Create 4 new components in `components/settings/`. All follow NativeWind v4 styling with cream (#FFF8F0) backgrounds and sage green (#7C9A72) accents.

**components/settings/SettingSection.tsx:**
- Props: `{ title: string; children: React.ReactNode }`
- Renders a View with:
  - Title text: `text-xs font-semibold text-gray-400 uppercase tracking-wider px-6 pt-6 pb-2` (section header)
  - Children wrapper: `bg-white rounded-xl mx-4 overflow-hidden` (white card containing child rows)
- This groups related settings visually (like iOS Settings app sections)

**components/settings/SettingRow.tsx:**
- Props: `{ label: string; description?: string; rightElement?: React.ReactNode; onPress?: () => void; disabled?: boolean }`
- If `onPress` provided, wrap in TouchableOpacity; otherwise View
- Layout: `flex-row items-center justify-between px-4 py-3.5 min-h-[52px]`
- Left side (flex-1): label as `text-base text-gray-900` (or `text-gray-400` if disabled), optional description below as `text-xs text-gray-500 mt-0.5`
- Right side: render `rightElement` if provided (for Switch, time display, chevron, etc.)
- Add a bottom border separator: `border-b border-gray-100` (last item won't need it, but CSS handles this fine)

**components/settings/NotificationTimePicker.tsx:**
- Props: `{ hour: number; minute: number; onChange: (hour: number, minute: number) => void; disabled?: boolean }`
- Import `DateTimePicker` and `DateTimePickerAndroid` from `@react-native-community/datetimepicker`
- Import `Platform, TouchableOpacity, Text, View` from 'react-native'
- State: `showIOSPicker` boolean (default false on iOS, hidden until tapped)
- Display: Show formatted time as touchable text (e.g., "9:00 AM" using 12-hour format with AM/PM)
- Format helper: Convert 24h hour/minute to "h:mm AM/PM" string
- **Android:** On press, call `DateTimePickerAndroid.open({ value: new Date(2024, 0, 1, hour, minute), mode: 'time', is24Hour: false, onChange: (event, date) => { if (event.type === 'set' && date) onChange(date.getHours(), date.getMinutes()) } })`
- **iOS:** On press, toggle `showIOSPicker`. When visible, render `DateTimePicker` component with `mode="time"` `display="spinner"` below the time text. onChange extracts hours/minutes and calls onChange prop.
- If disabled, show time text but don't respond to press (opacity-50)
- Time text styling: `text-base font-medium text-[#7C9A72]` (sage green, looks tappable)

**components/settings/DangerZone.tsx:**
- Props: `{ onResetHistory: () => void; resetting?: boolean }`
- Uses SettingSection with title "Danger Zone"
- Inside: a View with red-tinted background (`bg-red-50 rounded-xl mx-4 p-4`)
- Warning text: "These actions cannot be undone." in `text-xs text-red-400 mb-3`
- TouchableOpacity button: `bg-red-600 rounded-lg py-3 px-4` with text "Reset Prompt History" in white, centered
- If `resetting` is true, show ActivityIndicator instead of text, disable button
- onPress calls `onResetHistory` prop (parent handles the Alert.alert confirmation — NOT this component)

Wait, actually: the DangerZone should handle its own confirmation dialog to be self-contained. Change: onPress shows `Alert.alert('Reset Prompt History', 'This will permanently delete all your saved prompts, responses, and artwork. This action cannot be undone.', [{ text: 'Cancel', style: 'cancel' }, { text: 'Reset Everything', style: 'destructive', onPress: onResetHistory }])`. So the parent just passes the actual reset function, and DangerZone wraps it in confirmation.
  </action>
  <verify>
- All 4 files exist: `ls components/settings/SettingSection.tsx components/settings/SettingRow.tsx components/settings/NotificationTimePicker.tsx components/settings/DangerZone.tsx`
- Each file exports a default function component
- `grep -c "DateTimePickerAndroid" components/settings/NotificationTimePicker.tsx` returns 1+ (Android support present)
- `grep -c "destructive" components/settings/DangerZone.tsx` returns 1+ (confirmation dialog present)
- `npx tsc --noEmit` passes
  </verify>
  <done>
4 settings components created: SettingSection (grouped section card with header), SettingRow (label + right control), NotificationTimePicker (platform-specific time selection with 12hr AM/PM display), DangerZone (red-styled reset with confirmation dialog). All follow cream/sage/white design system.
  </done>
</task>

</tasks>

<verification>
- lib/notifications.ts has 7 exports (3 original + 4 new)
- Android notification channel created at module level
- app.json has expo-notifications plugin and SCHEDULE_EXACT_ALARM permission
- resetPromptHistory deletes responses then prompts for a user
- All 4 settings components render correctly with NativeWind classes
- No TypeScript errors across all modified/created files
</verification>

<success_criteria>
- All notification service extensions work (channel setup, push token, permission check, reschedule)
- Prompt history reset function deletes child records (responses) before parent (prompts)
- Settings components are composable and follow the app's design system
- No regressions to existing notification functionality (requestPermission, scheduleDailyPrompt, cancelAll)
</success_criteria>

<output>
After completion, create `.planning/phases/06-notifications-settings/06-01-SUMMARY.md`
</output>
