---
phase: 05-history-tracking
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/(auth)/history.tsx
  - app/(auth)/history/[id].tsx
  - app/(auth)/_layout.tsx
  - app/(auth)/index.tsx
  - app/(auth)/respond.tsx
autonomous: true

must_haves:
  truths:
    - "User can view scrollable list of past prompts with completed/not completed status"
    - "User can tap a prompt to see detail view with full text, linked responses, and photos"
    - "Prompts are automatically marked as completed when user adds a response"
    - "History list loads quickly and paginates smoothly with 100+ prompts"
  artifacts:
    - path: "app/(auth)/history.tsx"
      provides: "History list screen with FlatList, pagination, and pull-to-refresh"
      min_lines: 80
    - path: "app/(auth)/history/[id].tsx"
      provides: "Prompt detail screen with full prompt and linked responses with images"
      min_lines: 60
    - path: "app/(auth)/_layout.tsx"
      provides: "Stack routes for history and history/[id]"
      contains: "history"
    - path: "app/(auth)/index.tsx"
      provides: "Navigation link to history screen"
      contains: "history"
  key_links:
    - from: "app/(auth)/history.tsx"
      to: "lib/hooks/usePromptHistory.ts"
      via: "usePromptHistory hook call"
      pattern: "usePromptHistory"
    - from: "app/(auth)/history.tsx"
      to: "app/(auth)/history/[id].tsx"
      via: "router.push to detail"
      pattern: "router\\.push.*history/"
    - from: "app/(auth)/history/[id].tsx"
      to: "lib/services/prompts.ts"
      via: "getPromptById call"
      pattern: "getPromptById"
    - from: "app/(auth)/history/[id].tsx"
      to: "lib/services/responses.ts"
      via: "getResponsesForPromptWithImages call"
      pattern: "getResponsesForPromptWithImages"
    - from: "app/(auth)/respond.tsx"
      to: "lib/hooks/usePromptHistory.ts"
      via: "invalidateHistoryCache on response submit"
      pattern: "invalidateHistoryCache"
---

<objective>
Build the history UI screens (list + detail), wire navigation routes, add history access from the home screen, and add cache invalidation on response creation so the history stays up-to-date.

Purpose: Deliver the complete user-facing history feature — browse past prompts, see completion status, tap for details with photos.
Output: Two new screens (history list + prompt detail), updated navigation layout, home screen link, and automatic cache invalidation.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-tracking/05-RESEARCH.md
@.planning/phases/05-history-tracking/05-01-SUMMARY.md

@lib/schemas/prompts.ts
@lib/schemas/response.ts
@lib/services/prompts.ts
@lib/services/responses.ts
@lib/hooks/usePromptHistory.ts
@app/(auth)/index.tsx
@app/(auth)/_layout.tsx
@app/(auth)/respond.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build history list screen and prompt detail screen</name>
  <files>
    app/(auth)/history.tsx
    app/(auth)/history/[id].tsx
  </files>
  <action>
**app/(auth)/history.tsx** — History list screen with optimized FlatList.

Follow the UI patterns from index.tsx and respond.tsx: cream background (#FFF8F0), sage green (#7C9A72) accents, white card backgrounds, rounded-2xl cards, big obvious buttons.

**Structure:**
- Import usePromptHistory from `@/lib/hooks/usePromptHistory`
- Import router from `expo-router`
- Import React, { useCallback, memo } from 'react'
- Import { View, Text, FlatList, TouchableOpacity, ActivityIndicator, RefreshControl } from 'react-native'

**PromptListItem component** (memo-ized, defined above the screen export):
- Receives `prompt: PromptWithStatus` and `onPress: (id: string) => void`
- White card (bg-white rounded-xl p-4 mb-3 mx-6) with shadow-sm
- Top row: prompt_text truncated to 2 lines (`numberOfLines={2}`)
- Bottom row: left side shows date (format created_at as "Jan 15, 2026" using `new Date(prompt.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })`), right side shows completion badge
- Completion badge: if is_completed, show green rounded pill "Completed" (bg-[#7C9A72]/10 text-[#7C9A72]), else show gray rounded pill "Not yet" (bg-gray-100 text-gray-500)
- Wrap entire card in TouchableOpacity with onPress calling `onPress(prompt.id)`
- Use `React.memo` with areEqual: `(prev, next) => prev.prompt.id === next.prompt.id && prev.prompt.is_completed === next.prompt.is_completed`

**HistoryScreen:**
- Use usePromptHistory() hook
- States: refreshing (boolean) for pull-to-refresh indicator

**Loading state** (loading && prompts.length === 0): centered ActivityIndicator on cream background, same pattern as index.tsx loading state.

**Error state:** centered error message with "Try Again" sage green button, same pattern as index.tsx error state.

**Empty state:** centered message "No prompts yet" with subtext "Start creating art to build your history" and sage green "Go to Today's Prompt" button linking to `/(auth)`.

**Success state — FlatList config:**
- data={prompts}
- renderItem wrapped in useCallback: renders PromptListItem with onPress handler
- keyExtractor: `item => item.id`
- initialNumToRender={15}
- maxToRenderPerBatch={10}
- windowSize={5}
- onEndReached: call loadMore (wrapped in useCallback checking !loading && hasMore)
- onEndReachedThreshold={0.5}
- refreshControl: RefreshControl with refreshing state, onRefresh async handler calling refresh(), tintColor="#7C9A72"
- ListFooterComponent: if loading (and prompts exist — i.e., paginating), show ActivityIndicator; else null
- ListHeaderComponent: View with py-4, containing Text header "Your History" (text-2xl font-bold text-gray-900 px-6)
- contentContainerStyle={{ paddingBottom: 20, backgroundColor: '#FFF8F0' }}
- className="flex-1 bg-[#FFF8F0]"

**handlePress:** `useCallback((id: string) => router.push(\`/(auth)/history/\${id}\`), [])`

---

**app/(auth)/history/[id].tsx** — Prompt detail screen.

**Imports:** useLocalSearchParams and router from expo-router, useState/useEffect from react, View/Text/ScrollView/Image/TouchableOpacity/ActivityIndicator from react-native, getPromptById from services/prompts, getResponsesForPromptWithImages from services/responses, useSession from SessionProvider, Prompt/PromptWithStatus types, Response type, MEDIUM_OPTIONS/COLOR_PALETTE_OPTIONS from constants.

**State:** prompt (PromptWithStatus | null), responses (Response[]), loading (boolean), error (string | null)

**useEffect on mount:**
- Get `id` from useLocalSearchParams (cast as string)
- Get userId from useSession
- If __DEV__ and no userId: set mock prompt + mock responses, setLoading(false), return
- Fetch prompt via getPromptById(userId, id)
- Fetch responses via getResponsesForPromptWithImages(userId, id)
- Set state, handle errors

**Loading state:** centered ActivityIndicator on cream bg.

**Error state:** error message + "Go Back" button.

**UI layout (ScrollView):**
1. Back button: "← Back to History" (text-[#7C9A72]), onPress router.back()
2. Date display: formatted created_at (e.g., "January 15, 2026") using toLocaleDateString with long month
3. Source badge: "Daily Prompt" or "Extra Prompt" based on prompt.source — small pill badge
4. Main prompt card (white bg, rounded-2xl, p-6):
   - prompt_text in large text (text-xl font-semibold text-gray-900 leading-relaxed)
   - Details section (same pattern as index.tsx): Medium label, Color rule label (if present), Twist text (if present)
   - Completion status: green "Completed" badge or gray "Not yet responded"
5. Responses section (only shown if responses.length > 0):
   - Section header "Your Responses" (text-lg font-semibold text-gray-900 mb-3 px-6)
   - For each response: white card with:
     - Horizontal ScrollView of images (w-48 h-48 rounded-xl, using Image with source={{ uri }})
     - Notes text (if present, text-gray-600 italic)
     - Tags as chips (same style as respond.tsx tags: bg-[#7C9A72]/10 rounded-full px-3 py-1)
     - Date: response.created_at formatted
6. If no responses and not completed: message "You haven't responded to this prompt yet" with "Respond Now" sage green button linking to respond screen with prompt_id and prompt_text params

Helper function `getLabel` for looking up MEDIUM_OPTIONS/COLOR_PALETTE_OPTIONS labels (same pattern as index.tsx).

All styling follows existing app patterns: cream bg, sage green accents, white cards, rounded-2xl, clean spacing.
  </action>
  <verify>
  - Both files exist at app/(auth)/history.tsx and app/(auth)/history/[id].tsx
  - TypeScript compilation passes
  - history.tsx uses FlatList with all performance props (initialNumToRender, maxToRenderPerBatch, windowSize, onEndReached)
  - history.tsx uses memo-ized PromptListItem component
  - history/[id].tsx uses useLocalSearchParams to get prompt ID
  - Both screens handle loading, error, and empty states
  </verify>
  <done>
  - History list renders scrollable FlatList with completed/not completed badges per prompt
  - FlatList configured for 100+ item performance (virtualization, memo, batching)
  - Pull-to-refresh with sage green tint refreshes history data
  - Infinite scroll triggers loadMore at 50% threshold
  - Detail view shows full prompt text, medium/color/twist details, and all linked responses with photos
  - Detail view offers "Respond Now" button for uncompleted prompts
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire navigation routes and cache invalidation</name>
  <files>
    app/(auth)/_layout.tsx
    app/(auth)/index.tsx
    app/(auth)/respond.tsx
  </files>
  <action>
**app/(auth)/_layout.tsx** — Add Stack.Screen entries for history routes.

Add TWO new Stack.Screen entries inside the existing Stack component, after the "settings" screen:

```tsx
<Stack.Screen
  name="history"
  options={{
    title: 'History',
    headerShown: true,
  }}
/>
<Stack.Screen
  name="history/[id]"
  options={{
    title: 'Prompt Detail',
    headerShown: true,
  }}
/>
```

Do NOT modify any existing Stack.Screen entries. The respond screen does NOT have a Stack.Screen entry currently (it works as a catch-all route), so do NOT add one unless it is already there.

**app/(auth)/index.tsx** — Add navigation link to history.

Add a "View History" button between the "Generate Now" button and the "Settings" link. Use the outlined button style (same as "Generate Now"):

```tsx
{/* View History */}
<TouchableOpacity
  className="bg-white border-2 border-gray-300 rounded-xl py-4 mt-3"
  onPress={() => router.push('/(auth)/history')}
>
  <Text className="text-gray-700 text-center text-lg font-semibold">
    View History
  </Text>
</TouchableOpacity>
```

Place this AFTER the "Generate Now" TouchableOpacity and BEFORE the Settings link. Use gray border (border-gray-300) instead of sage green to visually differentiate it from primary actions. The hierarchy should be: sage green solid (I made something) > sage green outlined (Generate Now) > gray outlined (View History) > text link (Settings).

**app/(auth)/respond.tsx** — Add cache invalidation after successful response creation.

1. Import `invalidateHistoryCache` from `@/lib/hooks/usePromptHistory`
2. In the `handleSubmit` function, after `const response = await submitResponse(input);`, if response is truthy (successful upload), call `await invalidateHistoryCache()` before the Alert.alert call
3. Also call `await invalidateHistoryCache()` in the else branch (offline queue) before router.back()

This ensures that when the user navigates to history after creating a response, the cache is cleared and fresh data (with updated completion status) loads.

Do NOT modify any other part of respond.tsx. The invalidation calls are minimal additions.
  </action>
  <verify>
  - _layout.tsx has Stack.Screen entries for "history" and "history/[id]"
  - index.tsx has "View History" button with onPress navigating to /(auth)/history
  - respond.tsx imports and calls invalidateHistoryCache after both online and offline response submission
  - TypeScript compilation passes for all three files
  - No existing functionality broken (home screen still shows prompt, respond still submits)
  </verify>
  <done>
  - History and detail screens are navigable via Stack routes
  - Home screen has "View History" button below "Generate Now"
  - Creating a response (online or offline) invalidates history cache
  - Navigation hierarchy: I made something > Generate Now > View History > Settings
  - Full feature loop works: view prompt → create response → history shows completed
  </done>
</task>

</tasks>

<verification>
1. Navigate to history from home screen: "View History" button exists and navigates to history list
2. History list shows prompts with completion badges (green "Completed" or gray "Not yet")
3. Scroll through list: infinite scroll loads more prompts, no blank areas
4. Pull down to refresh: RefreshControl shows sage green spinner, data refreshes
5. Tap a prompt: navigates to detail view with full prompt text, medium, color, twist
6. Detail view shows response images if prompt was responded to
7. Create new response from home: navigate to history, prompt now shows "Completed"
8. Empty state: if no prompts, shows helpful message with link to today's prompt
</verification>

<success_criteria>
- User can navigate Home → History list → Prompt detail → back, without errors
- Prompts display completed/not completed badges based on response existence
- FlatList paginates smoothly with pull-to-refresh and infinite scroll
- Detail view renders prompt details and linked responses with actual photos
- Cache invalidation ensures new responses are reflected in history immediately
- All screens follow cream/sage green design system with clean card layouts
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-tracking/05-02-SUMMARY.md`
</output>
