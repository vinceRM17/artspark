---
phase: 02-onboarding-preferences
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/onboarding/_layout.tsx
  - app/onboarding/step-1.tsx
  - app/onboarding/step-2.tsx
  - app/onboarding/step-3.tsx
  - app/onboarding/step-4.tsx
autonomous: true

must_haves:
  truths:
    - "User can select preferred art mediums from a multi-select grid (ONBD-01)"
    - "User can optionally select color palette preferences or skip (ONBD-02)"
    - "User can select preferred subjects from a multi-select grid (ONBD-03)"
    - "User can exclude specific subjects or skip (ONBD-04)"
    - "User can navigate forward through steps 1-4"
    - "User can skip optional steps (colors, exclusions) without error"
  artifacts:
    - path: "app/onboarding/_layout.tsx"
      provides: "Stack navigator for onboarding with gesture disabled"
    - path: "app/onboarding/step-1.tsx"
      provides: "Medium selection screen (required, min 1)"
    - path: "app/onboarding/step-2.tsx"
      provides: "Color palette selection screen (optional, skippable)"
    - path: "app/onboarding/step-3.tsx"
      provides: "Subject selection screen (required, min 1)"
    - path: "app/onboarding/step-4.tsx"
      provides: "Exclusion selection screen (optional, skippable)"
  key_links:
    - from: "app/onboarding/step-1.tsx"
      to: "components/onboarding/OnboardingLayout.tsx"
      via: "wraps content in OnboardingLayout"
      pattern: "OnboardingLayout"
    - from: "app/onboarding/step-1.tsx"
      to: "lib/constants/preferences.ts"
      via: "imports MEDIUM_OPTIONS"
      pattern: "MEDIUM_OPTIONS"
    - from: "app/onboarding/step-1.tsx"
      to: "lib/schemas/onboarding.ts"
      via: "uses step1Schema for validation"
      pattern: "step1Schema|zodResolver"
    - from: "app/onboarding/step-1.tsx"
      to: "app/onboarding/step-2.tsx"
      via: "router.push on submit"
      pattern: "router\\.push.*step-2"
    - from: "app/onboarding/_layout.tsx"
      to: "expo-router"
      via: "Stack with gestureEnabled: false"
      pattern: "gestureEnabled.*false"
---

<objective>
Build onboarding steps 1-4: medium selection, color palette selection, subject selection, and exclusion selection.

Purpose: These four screens collect the user's art preferences using the chip-based multi-select components and schemas from Plan 01. Each step validates input, stores selections in React Hook Form state, and navigates forward. Steps 2 and 4 are skippable per requirements.

Output: Four screen files under app/onboarding/ plus a layout file. User can tap through steps 1-4 selecting preferences.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-onboarding-preferences/02-RESEARCH.md
@.planning/phases/02-onboarding-preferences/02-01-SUMMARY.md
@lib/schemas/onboarding.ts
@lib/constants/preferences.ts
@components/onboarding/OnboardingLayout.tsx
@components/onboarding/ChipGrid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding layout and steps 1-2 (mediums + colors)</name>
  <files>
    app/onboarding/_layout.tsx
    app/onboarding/step-1.tsx
    app/onboarding/step-2.tsx
  </files>
  <action>
**State management approach:** Each step screen manages its own form state via React Hook Form with zodResolver. To pass data between steps, use AsyncStorage with a key `@artspark:onboarding-progress` to store a JSON object of all selections so far. Each step reads existing data on mount and merges its selections before navigating forward. This avoids global state libraries while keeping data available across steps.

**1. Create `app/onboarding/_layout.tsx`:**
```typescript
import { Stack } from 'expo-router';

export default function OnboardingLayout() {
  return (
    <Stack
      screenOptions={{
        headerShown: false,
        gestureEnabled: false, // Prevent swipe-back during onboarding
        animation: 'slide_from_right',
      }}
    />
  );
}
```

**2. Create `app/onboarding/step-1.tsx` (Art Mediums - REQUIRED):**

Screen title: "What do you create with?"
Subtitle: "Pick the mediums you love working in. You can always change these later."

- Import useForm + Controller from react-hook-form, zodResolver from @hookform/resolvers/zod
- Import step1Schema from @/lib/schemas/onboarding
- Import MEDIUM_OPTIONS from @/lib/constants/preferences
- Import OnboardingLayout from @/components/onboarding/OnboardingLayout
- Import ChipGrid from @/components/onboarding/ChipGrid
- Import AsyncStorage for progress persistence

Form setup:
```typescript
const { control, handleSubmit, formState: { errors } } = useForm({
  resolver: zodResolver(step1Schema),
  defaultValues: { mediums: [] },
});
```

Render: OnboardingLayout wrapping a Controller that renders ChipGrid with MEDIUM_OPTIONS. The Controller's field.value is the selectedIds and field.onChange is called when ChipGrid toggles.

Toggle logic (inside the Controller render): When onToggle fires with an id, check if id is in current value. If yes, filter it out. If no, spread and add. Call field.onChange with the new array.

If errors.mediums exists, show error text below the ChipGrid ("Pick at least one medium" in red-500).

On handleSubmit success: Save `{ mediums: data.mediums }` to AsyncStorage key `@artspark:onboarding-progress` (merge with existing), then `router.push('/onboarding/step-2')`.

Next button disabled when mediums array is empty. Use `watch('mediums')` to reactively check.

**3. Create `app/onboarding/step-2.tsx` (Color Palettes - OPTIONAL):**

Screen title: "Any color preferences?"
Subtitle: "This is optional -- skip if you're open to any palette."

Same pattern as step-1 but with these differences:
- Uses step2Schema (colorPalettes is optional)
- Uses COLOR_PALETTE_OPTIONS from constants
- OnboardingLayout has `showSkip={true}` and `onSkip` navigates to step-3 (saves empty array)
- Next button is NEVER disabled (optional step)
- On submit or skip: Merge `{ colorPalettes: data.colorPalettes || [] }` into AsyncStorage progress, then `router.push('/onboarding/step-3')`

Step is 2 of 5.
  </action>
  <verify>
Run `npx tsc --noEmit`. All 3 files compile. Verify:
- `app/onboarding/_layout.tsx` exports default function with Stack and gestureEnabled: false
- `app/onboarding/step-1.tsx` imports step1Schema, MEDIUM_OPTIONS, uses Controller + ChipGrid
- `app/onboarding/step-2.tsx` imports step2Schema, COLOR_PALETTE_OPTIONS, has skip option
  </verify>
  <done>
Onboarding layout exists with gesture disabled. Step 1 shows medium selection with min-1 validation and error message. Step 2 shows color palette selection that is optional and skippable. Both steps persist progress to AsyncStorage and navigate forward.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create steps 3-4 (subjects + exclusions)</name>
  <files>
    app/onboarding/step-3.tsx
    app/onboarding/step-4.tsx
  </files>
  <action>
**1. Create `app/onboarding/step-3.tsx` (Subjects - REQUIRED):**

Screen title: "What inspires you?"
Subtitle: "Pick subjects you'd love to get prompts about."

Same pattern as step-1:
- Uses step3Schema (subjects array, min 1)
- Uses SUBJECT_OPTIONS from constants
- Step 3 of 5
- Next button disabled when subjects array empty
- Shows validation error if trying to proceed with empty selection
- On submit: Merge `{ subjects: data.subjects }` into AsyncStorage progress, then `router.push('/onboarding/step-4')`

**2. Create `app/onboarding/step-4.tsx` (Exclusions - OPTIONAL):**

Screen title: "Anything you'd rather avoid?"
Subtitle: "We'll make sure these never show up in your prompts. Skip if nothing bothers you."

This step reuses SUBJECT_OPTIONS (same list -- user picks which subjects to EXCLUDE from the full subject list).

IMPORTANT: Filter out subjects that the user already selected in step 3. Load AsyncStorage progress on mount to get `subjects` array. Only show SUBJECT_OPTIONS where the id is NOT in the already-selected subjects. This prevents contradictions (selecting "animals" as both a preference and exclusion).

Same pattern as step-2 (optional):
- Uses step4Schema (exclusions is optional)
- showSkip={true}, onSkip navigates to step-5
- Next button never disabled
- Step 4 of 5
- On submit or skip: Merge `{ exclusions: data.exclusions || [] }` into AsyncStorage progress, then `router.push('/onboarding/step-5')`
  </action>
  <verify>
Run `npx tsc --noEmit`. Both files compile. Verify:
- `app/onboarding/step-3.tsx` uses step3Schema, SUBJECT_OPTIONS, requires min 1 selection
- `app/onboarding/step-4.tsx` uses step4Schema, filters out already-selected subjects, is skippable
- Both persist to AsyncStorage and navigate to next step
  </verify>
  <done>
Step 3 shows subject selection with min-1 validation. Step 4 shows exclusion selection (optional, skippable) that filters out already-chosen subjects to prevent contradictions. All 4 preference steps now exist and users can navigate through them.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `app/onboarding/_layout.tsx` uses Stack with gestureEnabled: false
- Steps 1 and 3 enforce minimum 1 selection via Zod schema validation
- Steps 2 and 4 are optional with visible "Skip this step" button
- Step 4 filters out subjects selected in step 3
- All steps use OnboardingLayout with correct step/totalSteps
- All steps persist selections to AsyncStorage between navigations
- Navigation flows: step-1 -> step-2 -> step-3 -> step-4 -> step-5
</verification>

<success_criteria>
- All 5 files exist under app/onboarding/ (_layout + steps 1-4)
- Steps use ChipGrid for selection, OnboardingLayout for consistent look
- Required steps (1, 3) show validation errors on empty submission
- Optional steps (2, 4) have skip buttons and no minimum requirement
- Step 4 intelligently excludes already-selected subjects
- AsyncStorage used as intermediate state between steps
- Artistic styling consistent (cream backgrounds, sage green chips, warm feel)
</success_criteria>

<output>
After completion, create `.planning/phases/02-onboarding-preferences/02-02-SUMMARY.md`
</output>
