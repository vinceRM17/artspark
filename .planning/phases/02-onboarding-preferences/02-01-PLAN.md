---
phase: 02-onboarding-preferences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/schemas/onboarding.ts
  - lib/services/preferences.ts
  - lib/hooks/useOnboardingStatus.ts
  - lib/constants/preferences.ts
  - components/onboarding/OnboardingLayout.tsx
  - components/onboarding/ProgressIndicator.tsx
  - components/onboarding/PreferenceChip.tsx
  - components/onboarding/ChipGrid.tsx
autonomous: true

must_haves:
  truths:
    - "Preference data shapes are validated at compile time and runtime via Zod"
    - "Supabase preferences service can upsert and read user preferences"
    - "Onboarding status can be checked for any authenticated user"
    - "Reusable UI components render multi-select chip grids with artistic styling"
  artifacts:
    - path: "lib/schemas/onboarding.ts"
      provides: "Zod schemas for each onboarding step and complete preferences"
      exports: ["step1Schema", "step2Schema", "step3Schema", "step4Schema", "step5Schema", "completeOnboardingSchema", "OnboardingData"]
    - path: "lib/services/preferences.ts"
      provides: "Supabase CRUD operations for user_preferences"
      exports: ["savePreferences", "getPreferences", "UserPreferences"]
    - path: "lib/hooks/useOnboardingStatus.ts"
      provides: "Hook to check if user has completed onboarding"
      exports: ["useOnboardingStatus"]
    - path: "lib/constants/preferences.ts"
      provides: "Option lists for mediums, colors, subjects"
      exports: ["MEDIUM_OPTIONS", "COLOR_PALETTE_OPTIONS", "SUBJECT_OPTIONS"]
    - path: "components/onboarding/OnboardingLayout.tsx"
      provides: "Shared onboarding screen wrapper with progress, title, artistic styling"
    - path: "components/onboarding/ChipGrid.tsx"
      provides: "Tappable chip grid for multi-select preferences"
  key_links:
    - from: "lib/services/preferences.ts"
      to: "lib/supabase.ts"
      via: "imports supabase client"
      pattern: "import.*supabase.*from.*@/lib/supabase"
    - from: "lib/hooks/useOnboardingStatus.ts"
      to: "lib/services/preferences.ts"
      via: "calls getPreferences"
      pattern: "getPreferences|supabase.*user_preferences"
    - from: "lib/schemas/onboarding.ts"
      to: "lib/constants/preferences.ts"
      via: "schema values align with option IDs"
---

<objective>
Build the data layer (schemas, services, hooks) and reusable UI components for the onboarding flow.

Purpose: Establishes the foundation that all 5 onboarding steps will use -- validated data shapes, Supabase persistence, onboarding status detection, and artistic chip-based multi-select components. Doing this first means the screen plans can focus purely on flow and UX.

Output: Zod schemas, Supabase preferences service, useOnboardingStatus hook, preference option constants, and reusable onboarding UI components (layout wrapper, progress indicator, chip grid).
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-onboarding-preferences/02-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@lib/supabase.ts
@components/auth/SessionProvider.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schemas, services, hooks, and preference constants</name>
  <files>
    lib/schemas/onboarding.ts
    lib/services/preferences.ts
    lib/hooks/useOnboardingStatus.ts
    lib/constants/preferences.ts
  </files>
  <action>
**Install dependencies first:**
```bash
npm install react-hook-form zod @hookform/resolvers
```

**1. Create `lib/constants/preferences.ts`:**
Define all preference option arrays. Each option is `{ id: string; label: string }`. These are the canonical option lists used by both UI and validation.

MEDIUM_OPTIONS (at least these, add more if sensible):
- watercolor, gouache, acrylic, oil, pencil, ink, digital, collage, paper-art, pastel, charcoal, mixed-media

COLOR_PALETTE_OPTIONS:
- earthy, vibrant, monochrome, pastels, complementary, warm, cool, random-ok

SUBJECT_OPTIONS (at least these, add more if sensible):
- animals, landscapes, people-portraits, still-life, abstract, urban, botanicals, fantasy, food, architecture, patterns, mythology

**2. Create `lib/schemas/onboarding.ts`:**
Use Zod. Import from 'zod'.

- `step1Schema`: `{ mediums: z.array(z.string()).min(1, 'Pick at least one medium') }`
- `step2Schema`: `{ colorPalettes: z.array(z.string()).optional().default([]) }` -- this step is optional per requirements
- `step3Schema`: `{ subjects: z.array(z.string()).min(1, 'Pick at least one subject') }`
- `step4Schema`: `{ exclusions: z.array(z.string()).optional().default([]) }` -- optional, user may have no exclusions
- `step5Schema`: `{ notificationHour: z.number().min(0).max(23), notificationMinute: z.number().min(0).max(59) }`
- `completeOnboardingSchema`: Combines all fields into one object
- Export `type OnboardingData = z.infer<typeof completeOnboardingSchema>`

**3. Create `lib/services/preferences.ts`:**
Import `supabase` from `@/lib/supabase`.

Define `UserPreferences` type matching the Supabase table:
```typescript
export type UserPreferences = {
  id: string;
  user_id: string;
  onboarding_completed: boolean;
  art_mediums: string[];
  color_palettes: string[];
  subjects: string[];
  exclusions: string[];
  notification_time: string; // HH:MM:SS format
  notification_enabled: boolean;
  created_at: string;
  updated_at: string;
};
```

Functions:
- `savePreferences(userId: string, preferences: Partial<Omit<UserPreferences, 'id' | 'user_id' | 'created_at' | 'updated_at'>>)`: Uses `.upsert()` with `onConflict: 'user_id'`. Sets `updated_at: new Date().toISOString()`. Includes `.select().single()` to verify. Returns data or throws.
- `getPreferences(userId: string)`: Uses `.select('*').eq('user_id', userId).single()`. Returns data or null (handle PGRST116 "no rows" error gracefully by returning null, re-throw other errors).
- `markOnboardingComplete(userId: string)`: Calls savePreferences with `{ onboarding_completed: true }`.

IMPORTANT: The Supabase table `user_preferences` does NOT exist yet. This service will be used once the table is created. Add a comment at the top: `// Requires user_preferences table in Supabase -- see SQL migration in plan 02-02 or create manually`.

The table must be created in Supabase SQL editor by the user or during plan execution. Include the full CREATE TABLE + RLS SQL as a comment block at the top of the file so it's easy to find:

```sql
-- Run this in Supabase SQL Editor:
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  onboarding_completed BOOLEAN DEFAULT FALSE,
  art_mediums TEXT[] NOT NULL DEFAULT '{}',
  color_palettes TEXT[] DEFAULT '{}',
  subjects TEXT[] NOT NULL DEFAULT '{}',
  exclusions TEXT[] DEFAULT '{}',
  notification_time TIME DEFAULT '09:00:00',
  notification_enabled BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own preferences"
  ON user_preferences FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own preferences"
  ON user_preferences FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own preferences"
  ON user_preferences FOR UPDATE
  USING (auth.uid() = user_id);
```

**4. Create `lib/hooks/useOnboardingStatus.ts`:**
Import `useSession` from `@/components/auth/SessionProvider` and `getPreferences` from `@/lib/services/preferences`.

Returns `{ onboardingComplete: boolean | null; loading: boolean }`.
- On mount (useEffect with session?.user?.id dep), calls getPreferences.
- If no preferences row or `onboarding_completed === false`, returns `{ onboardingComplete: false }`.
- If `onboarding_completed === true`, returns `{ onboardingComplete: true }`.
- While loading, returns `{ onboardingComplete: null, loading: true }`.
- In __DEV__ mode, provide a way to override: check AsyncStorage key `@artspark:dev-skip-onboarding`. If set to 'true', return `{ onboardingComplete: true, loading: false }` immediately.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. All 4 new files should compile without errors. Verify exports: schemas export step1-5 + completeOnboardingSchema + OnboardingData type, services export savePreferences + getPreferences + markOnboardingComplete, hook exports useOnboardingStatus, constants export MEDIUM_OPTIONS + COLOR_PALETTE_OPTIONS + SUBJECT_OPTIONS.
  </verify>
  <done>
All 4 files exist and compile. Zod schemas validate mediums (min 1), colors (optional), subjects (min 1), exclusions (optional), notification time (hour/minute). Preferences service has upsert + read + markComplete functions. useOnboardingStatus hook checks Supabase for completion flag with __DEV__ bypass support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build reusable onboarding UI components</name>
  <files>
    components/onboarding/OnboardingLayout.tsx
    components/onboarding/ProgressIndicator.tsx
    components/onboarding/PreferenceChip.tsx
    components/onboarding/ChipGrid.tsx
  </files>
  <action>
All components use NativeWind v4 `className` props for styling. Follow the artistic direction: clean, warm, plant-inspired feel (earthy colors like sage green, warm cream backgrounds, soft rounded corners). StoryGraph-inspired means clean cards with generous whitespace, readable typography, not cluttered.

**1. Create `components/onboarding/ProgressIndicator.tsx`:**
Props: `{ currentStep: number; totalSteps: number }`
Renders a row of small circles/dots. Active step is filled (sage green #7C9A72), completed steps are filled lighter, upcoming steps are outlined. Below the dots, show text like "Step 2 of 5". Use View + className for layout, no external libraries.

**2. Create `components/onboarding/PreferenceChip.tsx`:**
Props: `{ label: string; selected: boolean; onPress: () => void }`
A tappable chip/pill component. When selected: filled background (sage green #7C9A72, white text). When unselected: outlined (border with cream/warm gray background). Use TouchableOpacity. Rounded-full, px-4 py-2, text-base font size. Big enough to easily tap (min height 44px for accessibility per Apple HIG).

**3. Create `components/onboarding/ChipGrid.tsx`:**
Props: `{ options: Array<{ id: string; label: string }>; selectedIds: string[]; onToggle: (id: string) => void; columns?: number }`
Renders a flexWrap row of PreferenceChip components. When a chip is tapped, it calls onToggle with the option id. The parent manages the selected state (controlled component pattern). Default to 3 columns approximation via flex-wrap.

**4. Create `components/onboarding/OnboardingLayout.tsx`:**
Props: `{ children: React.ReactNode; step: number; totalSteps: number; title: string; subtitle?: string; onNext: () => void; onSkip?: () => void; nextLabel?: string; nextDisabled?: boolean; showSkip?: boolean }`

Layout structure (top to bottom):
- SafeAreaView wrapper with warm cream background (#FFF8F0 or similar)
- ProgressIndicator at top
- Title (text-2xl font-bold, dark text) and optional subtitle (text-base text-gray-500)
- Scrollable content area (children) -- use ScrollView so long option lists don't get cut off
- Bottom action area (fixed at bottom, not scrolling):
  - "Next" button: Large, filled sage green, white text, rounded-xl, py-4, full width. Label defaults to "Next" but is overridable. Disabled state grays it out.
  - Optional "Skip" text button below: smaller, text-gray-500, "Skip this step"

Per user direction: "big, obvious buttons with minimal taps." The Next button should be prominent and unmissable.

Keep artistic touches simple for now -- warm color palette, generous spacing, rounded shapes. Avoid complex SVG illustrations (keep scope tight). The artistic feel comes from the color palette (creams, sage greens, warm grays) and typography, not from decorative elements.
  </action>
  <verify>
Run `npx tsc --noEmit`. All 4 component files compile without errors. Verify each component exports a default or named export. OnboardingLayout renders ProgressIndicator. ChipGrid renders PreferenceChip for each option.
  </verify>
  <done>
Four reusable components exist: OnboardingLayout (wraps each step with progress, title, buttons), ProgressIndicator (dot-based step tracker), PreferenceChip (tappable selection pill), ChipGrid (multi-select grid of chips). All use NativeWind className styling with warm/artistic color palette (cream background, sage green accents). Components are controlled (parent manages state).
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- lib/schemas/onboarding.ts exports all 5 step schemas plus combined schema and OnboardingData type
- lib/services/preferences.ts exports savePreferences, getPreferences, markOnboardingComplete
- lib/hooks/useOnboardingStatus.ts exports useOnboardingStatus
- lib/constants/preferences.ts exports MEDIUM_OPTIONS, COLOR_PALETTE_OPTIONS, SUBJECT_OPTIONS with 8+ options each
- components/onboarding/ has 4 component files that import and use each other correctly
</verification>

<success_criteria>
- All data layer files (schemas, services, hooks, constants) exist and compile
- All UI component files exist and compile
- Schemas enforce min(1) on mediums and subjects, optional on colors and exclusions
- Preferences service uses Supabase upsert pattern with onConflict: 'user_id'
- SQL migration for user_preferences table is documented in preferences.ts comments
- OnboardingLayout provides consistent step wrapper with warm artistic styling
- ChipGrid + PreferenceChip provide multi-select interaction pattern
- useOnboardingStatus has __DEV__ bypass
</success_criteria>

<output>
After completion, create `.planning/phases/02-onboarding-preferences/02-01-SUMMARY.md`
</output>
