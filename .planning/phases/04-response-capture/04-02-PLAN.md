---
phase: 04-response-capture
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/hooks/useImagePicker.ts
  - lib/hooks/useNetworkStatus.ts
  - lib/hooks/useResponseUpload.ts
  - app/(auth)/respond.tsx
  - app/(auth)/index.tsx
autonomous: false

must_haves:
  truths:
    - "User can tap 'I made something' on home screen and navigate to response creation"
    - "User can select 1-3 photos from library or take a photo with camera"
    - "User can add optional notes text (up to 500 characters)"
    - "User can add optional tags to their response"
    - "User sees loading state during image compression and upload"
    - "User can share uploaded artwork via native share sheet"
    - "Responses created offline are queued and upload when connectivity returns"
  artifacts:
    - path: "lib/hooks/useImagePicker.ts"
      provides: "Image selection from camera/gallery with permissions"
      exports: ["useImagePicker"]
    - path: "lib/hooks/useNetworkStatus.ts"
      provides: "Network connectivity monitoring and queue processing trigger"
      exports: ["useNetworkStatus"]
    - path: "lib/hooks/useResponseUpload.ts"
      provides: "Orchestrates response creation (upload, save, queue if offline)"
      exports: ["useResponseUpload"]
    - path: "app/(auth)/respond.tsx"
      provides: "Response creation screen with image picker, notes, tags, submit, share"
    - path: "app/(auth)/index.tsx"
      provides: "Updated home screen with navigation to respond screen"
  key_links:
    - from: "app/(auth)/respond.tsx"
      to: "lib/hooks/useResponseUpload.ts"
      via: "useResponseUpload hook call"
      pattern: "useResponseUpload"
    - from: "app/(auth)/respond.tsx"
      to: "lib/hooks/useImagePicker.ts"
      via: "useImagePicker hook call"
      pattern: "useImagePicker"
    - from: "lib/hooks/useResponseUpload.ts"
      to: "lib/services/responses.ts"
      via: "createResponse call"
      pattern: "createResponse"
    - from: "lib/hooks/useResponseUpload.ts"
      to: "lib/services/offlineQueue.ts"
      via: "queueUpload on offline, processQueue on reconnect"
      pattern: "queueUpload|processQueue"
    - from: "lib/hooks/useNetworkStatus.ts"
      to: "lib/services/offlineQueue.ts"
      via: "processQueue trigger on connectivity change"
      pattern: "processQueue"
    - from: "app/(auth)/index.tsx"
      to: "app/(auth)/respond.tsx"
      via: "router.push with prompt_id param"
      pattern: "router\\.push.*respond"
    - from: "app/(auth)/respond.tsx"
      to: "expo-sharing"
      via: "Sharing.shareAsync for artwork share"
      pattern: "Sharing\\.shareAsync"
---

<objective>
Build the React Native hooks and response creation screen that lets users photograph their artwork, add notes and tags, submit responses (with offline support), and share via native share sheet.

Purpose: Connect the data layer from Plan 01 to user-facing UI. This is the primary user interaction for Phase 4 â€” the moment an artist says "I made something" and captures their creation.
Output: 3 hooks + 1 new screen + 1 modified screen
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-response-capture/04-RESEARCH.md
@.planning/phases/04-response-capture/04-01-SUMMARY.md

@lib/supabase.ts
@lib/schemas/response.ts
@lib/constants/upload.ts
@lib/services/imageUpload.ts
@lib/services/responses.ts
@lib/services/offlineQueue.ts
@lib/hooks/useDailyPrompt.ts
@app/(auth)/index.tsx
@components/auth/SessionProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build useImagePicker, useNetworkStatus, and useResponseUpload hooks</name>
  <files>
    lib/hooks/useImagePicker.ts
    lib/hooks/useNetworkStatus.ts
    lib/hooks/useResponseUpload.ts
  </files>
  <action>
**1. Create `lib/hooks/useImagePicker.ts`:**

Follow pattern from useDailyPrompt.ts (useState-based hook, returns object).

Export `useImagePicker()` returning:
```typescript
{
  images: string[];           // Selected image URIs (0-3)
  pickFromLibrary: () => Promise<void>;
  pickFromCamera: () => Promise<void>;
  removeImage: (index: number) => void;
  clearImages: () => void;
}
```

Implementation:
- `images` state: `useState<string[]>([])`
- `pickFromLibrary`:
  1. Request permissions: `ImagePicker.requestMediaLibraryPermissionsAsync()`
  2. If denied, show Alert explaining why permission is needed, return early
  3. Calculate remaining slots: `MAX_IMAGES - images.length`
  4. If no slots, show Alert "Maximum 3 images", return early
  5. Launch picker: `ImagePicker.launchImageLibraryAsync({ mediaTypes: ['images'], allowsMultipleSelection: true, selectionLimit: remainingSlots, quality: 1.0, allowsEditing: false })`
  6. If not canceled, append new URIs to images state (respect MAX_IMAGES cap)
- `pickFromCamera`:
  1. Request camera permissions: `ImagePicker.requestCameraPermissionsAsync()`
  2. If denied, show Alert, return early
  3. If images.length >= MAX_IMAGES, show Alert, return early
  4. Launch camera: `ImagePicker.launchCameraAsync({ mediaTypes: ['images'], quality: 1.0, allowsEditing: false })`
  5. If not canceled, append single URI to images state
- `removeImage(index)`: Filter out image at index
- `clearImages()`: Set images to empty array

Import MAX_IMAGES from lib/constants/upload.ts. Use expo-image-picker.

**2. Create `lib/hooks/useNetworkStatus.ts`:**

Export `useNetworkStatus()` returning:
```typescript
{
  isConnected: boolean;
  isInternetReachable: boolean | null;
}
```

Implementation:
- Use `useState` for isConnected (default true) and isInternetReachable (default null)
- In `useEffect`, subscribe to NetInfo: `NetInfo.addEventListener(state => { setIsConnected(!!state.isConnected); setIsInternetReachable(state.isInternetReachable); })`
- Also call `NetInfo.fetch()` on mount for initial state
- Return cleanup function (unsubscribe)
- Import from @react-native-community/netinfo

**3. Create `lib/hooks/useResponseUpload.ts`:**

Export `useResponseUpload()` returning:
```typescript
{
  submitResponse: (input: CreateResponseInput) => Promise<Response | null>;
  uploading: boolean;
  error: string | null;
  queueLength: number;
}
```

Implementation:
- Get userId from `useSession()` hook
- Get `isConnected` from `useNetworkStatus()` hook
- State: `uploading` (boolean), `error` (string|null), `queueLength` (number)
- On mount useEffect: call `getQueueLength()` to initialize queueLength. Also call `cleanupExpiredItems()` to purge old queue items on app start.
- useEffect watching `isConnected`: when isConnected becomes true, call `processQueue(createResponse)` and update queueLength afterward.
- `submitResponse(input)`:
  1. Set uploading=true, error=null
  2. Validate input with createResponseSchema.safeParse(). If invalid, set error and return null.
  3. If online (isConnected):
     - Try `createResponse(userId, input)`
     - On success: set uploading=false, return response
     - On error: fall through to offline queue
  4. If offline OR online upload failed:
     - Call `queueUpload(userId, input)`
     - Update queueLength
     - Set uploading=false
     - Show Alert: "Saved offline! Your response will upload when you're back online."
     - Return null (queued, not yet created)
  5. Always set uploading=false in finally block

Import createResponse from lib/services/responses.ts, queueUpload/processQueue/getQueueLength/cleanupExpiredItems from lib/services/offlineQueue.ts, createResponseSchema from lib/schemas/response.ts, useSession from components/auth/SessionProvider.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. lib/hooks/useImagePicker.ts exports useImagePicker with images, pickFromLibrary, pickFromCamera, removeImage, clearImages
3. useImagePicker requests permissions BEFORE launching picker (iOS requirement)
4. useImagePicker respects MAX_IMAGES (3) limit
5. lib/hooks/useNetworkStatus.ts exports useNetworkStatus with isConnected, isInternetReachable
6. useNetworkStatus subscribes to NetInfo and cleans up on unmount
7. lib/hooks/useResponseUpload.ts exports useResponseUpload with submitResponse, uploading, error, queueLength
8. useResponseUpload falls back to offline queue when isConnected is false or upload fails
9. useResponseUpload triggers processQueue when connectivity restores
10. useResponseUpload validates input with Zod schema before submission
  </verify>
  <done>
Three hooks fully implemented: useImagePicker (camera + gallery with permissions and MAX_IMAGES limit), useNetworkStatus (NetInfo listener with cleanup), useResponseUpload (online/offline submission orchestrator with queue management). All hooks follow useState/useEffect pattern from useDailyPrompt.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build response creation screen and wire home screen navigation</name>
  <files>
    app/(auth)/respond.tsx
    app/(auth)/index.tsx
  </files>
  <action>
**1. Create `app/(auth)/respond.tsx`:**

This is the core response creation screen. Follow the established UI patterns: cream (#FFF8F0) background, sage green (#7C9A72) accents, big obvious buttons, clean card layout.

Route receives `prompt_id` and `prompt_text` as query params via `useLocalSearchParams()` from expo-router.

Screen layout (ScrollView, px-6 padding):

**Header section:**
- Back button (TouchableOpacity with "<" or "Back" text, navigates back with router.back())
- Title: "Respond to Prompt" (text-lg, font-semibold, text-gray-900)
- Show prompt_text in a subtle card (bg-white rounded-xl p-4, text-sm text-gray-600 italic) so user remembers what they're responding to

**Image selection section:**
- Use `useImagePicker()` hook
- Row of image previews (horizontal ScrollView or flex-row flex-wrap):
  - Each selected image shown as 100x100 rounded thumbnail with an "X" remove button overlay
  - Use `<Image source={{ uri }} className="w-24 h-24 rounded-xl" resizeMode="cover" />` from react-native
- Two buttons below images:
  - "Choose from Library" (sage green outlined button) -> calls `pickFromLibrary()`
  - "Take Photo" (sage green outlined button) -> calls `pickFromCamera()`
- Show count: "{images.length}/3 photos" text below buttons
- If images.length === 0, show placeholder text: "Add at least one photo of your artwork"

**Notes section:**
- Label: "Notes (optional)" (text-sm text-gray-500)
- TextInput multiline, 4 lines height, placeholder "How did it go? What did you learn?", maxLength 500
- Character count: "{notes.length}/500"
- Styled: bg-white rounded-xl p-4 border border-gray-200, text-base text-gray-900

**Tags section:**
- Label: "Tags (optional)" (text-sm text-gray-500)
- TextInput single line, placeholder "Add tags separated by commas"
- Below input, show parsed tags as small chips (bg-[#7C9A72]/10 rounded-full px-3 py-1, text-[#7C9A72] text-xs)
- Parse tags: split by comma, trim whitespace, filter empty, limit to 10 tags, each max 30 chars
- Allow removing tags by tapping the chip (add "x" to each chip)

**Submit button:**
- Use `useResponseUpload()` hook
- Big sage green button: "Share My Creation" (disabled when images.length === 0 or uploading)
- Show ActivityIndicator when uploading
- On press:
  1. Parse tags from comma-separated string
  2. Build CreateResponseInput: { prompt_id, image_uris: images, notes: notes || null, tags }
  3. Call submitResponse(input)
  4. On success (response returned):
     - Show success Alert with option to share: Alert.alert("Saved!", "Your response has been saved.", [{ text: "Share", onPress: () => handleShare(response.image_urls[0]) }, { text: "Done", onPress: () => router.back() }])
  5. On null return (queued offline):
     - router.back() (alert already shown by hook)

**Share function (`handleShare`):**
- Import Sharing from expo-sharing
- Check `Sharing.isAvailableAsync()`
- If available: `Sharing.shareAsync(imageUri, { mimeType: 'image/jpeg', dialogTitle: 'Share your artwork' })`
- If not available: Alert "Sharing is not available on this device"
- NOTE: For sharing, we need the local image URI (not the Supabase URL). Keep a reference to the first selected image URI for sharing purposes.

**Offline indicator:**
- Use `useNetworkStatus()` hook
- If not connected, show subtle banner at top: "You're offline. Your response will be saved and uploaded later." (bg-yellow-50 text-yellow-700 text-xs p-2 rounded)
- Also show queueLength if > 0: "{queueLength} response(s) waiting to upload"

**Dev mode (__DEV__):**
- If no userId in dev mode, use 'dev-user' as userId (follow existing __DEV__ bypass pattern)
- If no prompt_id param, use 'dev-prompt-id' as fallback

**2. Update `app/(auth)/index.tsx`:**

Replace the "I made something" button's Alert placeholder with navigation:

Change:
```typescript
onPress={() => {
  Alert.alert(
    'Coming Soon',
    'Response capture is coming in the next update!'
  );
}}
```

To:
```typescript
onPress={() => {
  if (prompt) {
    router.push({
      pathname: '/(auth)/respond',
      params: { prompt_id: prompt.id, prompt_text: prompt.prompt_text }
    });
  }
}}
```

Add `import { router } from 'expo-router';` if not already present (it is).

No other changes to index.tsx.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. app/(auth)/respond.tsx exists and renders:
   - Prompt text display
   - Image picker with library and camera buttons
   - Image previews (thumbnails) with remove buttons
   - Notes TextInput (multiline, max 500 chars)
   - Tags input with chip display
   - Submit button ("Share My Creation")
   - Offline indicator banner
3. app/(auth)/index.tsx "I made something" button navigates to respond screen with prompt_id and prompt_text params
4. respond.tsx uses useImagePicker, useResponseUpload, and useNetworkStatus hooks
5. respond.tsx calls Sharing.shareAsync on successful submission
6. respond.tsx shows loading state (ActivityIndicator) during upload
7. respond.tsx disables submit when no images selected or uploading in progress
8. respond.tsx handles offline case (queue + alert + navigate back)
  </verify>
  <done>
Response creation screen fully built with image selection (camera + library), notes, tags, submit with offline fallback, and native share sheet integration. Home screen "I made something" button wired to navigate to respond screen with prompt context. Cream/sage green styling consistent with existing UI.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. User flow works end-to-end: Home screen -> "I made something" -> Respond screen -> select images -> add notes/tags -> submit -> success with share option
3. Image picker requests permissions before opening (iOS requirement)
4. Maximum 3 images enforced in picker and UI
5. Offline banner shown when not connected
6. Submit falls back to queue when offline
7. Share sheet opens via expo-sharing after successful upload
8. Queue processes automatically when connectivity restores
9. All styling follows cream (#FFF8F0) background + sage green (#7C9A72) accent pattern
</verification>

<success_criteria>
- useImagePicker hook handles camera + gallery with permissions and 3-image limit
- useNetworkStatus hook monitors connectivity with NetInfo
- useResponseUpload hook orchestrates online upload or offline queue fallback
- Respond screen has image previews, notes input, tags input, submit button, share option
- Home screen "I made something" navigates to respond with prompt context
- Offline indicator shows when disconnected
- Native share sheet accessible after successful submission
- All 5 files compile cleanly with existing codebase
</success_criteria>

<output>
After completion, create `.planning/phases/04-response-capture/04-02-SUMMARY.md`
</output>
